<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

    <title>Echtzeit-Chat</title>
</head>
<body>
    <h1>Echtzeit-Chat</h1>
    <div id="contacts-container">
      <ul id="contacts"></ul>
    </div>
    <div id="chat-container">
        <button id="logout-button">Logout</button> <!-- Logout-Button hinzugefügt -->
        <div id="user-info-bar"></div>
        <ul id="messages"></ul>
        <div id="send-container">
            <form id="chat-form">
                <input id="message-input" autocomplete="off"><button id="send-button">Senden</button>
            </form>
        </div>
    </div>
    

    

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Verbindung mit dem Socket.IO-Server herstellen
        const socket = io();


        let CURRENT_USER = "Barack Michelle Trump";
        let CURRENT_GROUP = null;

        var currently_loading_messages = false;

        var pending_messages = [];

        const input = document.getElementById("message-input");
        const messageContainer = document.getElementById('message-history-container');
        const messagesUL = document.getElementById('messages');


        var user2_id = 1;

        const bottomThreshold = 150;

        function isListNearBottom() {
            // Calculate the distance from the bottom
            const distanceFromBottom = messagesUL.scrollHeight - messagesUL.scrollTop - messagesUL.clientHeight;
            
            // Return true if within threshold, false otherwise
            return distanceFromBottom < bottomThreshold;
        }

        function scrollMessagesToBottom(){
            messagesUL.scrollTop = messagesUL.scrollHeight;
        }

        function requestHistoryMessages(start_at_id, number_of_messages) {
            socket.emit('get-history', { user2_id, start_at_id, number_of_messages });
        }

        socket.on('response-history', (data) => {
            console.log('Received data from server:', data); // Process the returned data
            if (!data.success){return; };
            
            let messages = data.messages;
            let msg;
            for (let i=messages.length-1; i>= 0; i--){
                const scrollPosition = messagesUL.scrollTop;
                const offsetHeightBefore = messagesUL.scrollHeight;
                msg = messages[i];
                let messageType = 'sent';
                if (msg.from_user != "Karl"){
                    messageType = 'received'
                }
                addMessage(msg.text, messageType, on_top=true);
                if (on_top) {
                    const offsetHeightAfter = messagesUL.scrollHeight;
                    messagesUL.scrollTop = scrollPosition + (offsetHeightAfter - offsetHeightBefore);
                }
            }

            

            currently_loading_messages = false;
        });


        function addMessage(message, messageType, on_top=false){
            // messageType can be 'pending' / 'sent' / 'received'

            // Nachricht sofort anzeigen
            const li = document.createElement('li');

            li.classList.add("message-container");            
            
            const msg = document.createElement('div');

            msg.innerText = message;

            msg.classList.add('message');
            msg.classList.add('new-message');
            
            switch(messageType) {
                case "pending":
                li.classList.add('right');
                msg.classList.add('pending-message');
                    break;
                
                case "sent":
                    li.classList.add('right');
                    msg.classList.add('sent-message');
                    break;
                
                case "received":
                    li.classList.add('left');
                    msg.classList.add('received-message');
                    break;
            }


            li.appendChild(msg);


            
            if (on_top){
                messagesUL.insertBefore(li, messagesUL.firstChild);
            }else{
                messagesUL.appendChild(li);
            } 

            // msg.addEventListener('transitionend', scrollMessagesToBottom);
            setTimeout(() => {
                msg.classList.add('expanded');
            }, 10);

            

            return li;
        }


        // Wenn eine Nachricht empfangen wird
        socket.on('chat message', (msg) => {
            console.log("RECEIVED:", msg);
            let li = addMessage(msg, 'received');
            if (isListNearBottom()) {
                console.log("SCROLLIN");
                setTimeout(scrollMessagesToBottom, 0);
            }
          
        });

        // Wenn eine Nachricht als bestätigt zurückkommt
        socket.on('message confirmation', (msgID) => {
            // Suchen der Nachricht mit der erhaltenen msgID
            const li = pending_messages[msgID];
            if (li) {
                const msg = li.querySelector("div");
                msg.classList.remove('pending-message'); // Entfernt den Pending-Status
                msg.classList.add('sent-message'); // Fügt die normale Nachricht-Klasse hinzu
                // Hier ein Script ausführen, z. B. Animation oder Bestätigung
                console.log("Message confirmed sent: " + msgID);
                delete pending_messages[msgID]; // Entferne das Pending-Tracking
            }
        });
        function sendMessage(event) {
            event.preventDefault(); 
            const msgID = Date.now(); 

            if (input.value == ""){
                return;
            }
            let msgLi = addMessage(input.value, 'pending');
            pending_messages[msgID] = msgLi;

            setTimeout(scrollMessagesToBottom, 0);

            let to_user = CURRENT_USER;

            let to_group = CURRENT_GROUP;

            let value = input.value;

            input.value = ''; // Eingabefeld leeren

            // Nachricht mit ID an den Server senden
            socket.emit('chat message', { id: msgID, to_user: to_user, to_group: to_group, text: value }); 
            
            setTimeout(() => {
                     document.getElementById('message-input').focus();
            }, 1000);
        }

        // Nachricht senden
        document.getElementById('chat-form').addEventListener('submit', sendMessage);
        document.getElementById('send-button').addEventListener("touchend", (e) => {
            e.preventDefault();
            sendMessage(e); // Event für Touch-Ende hinzufügen
        });


    // Nachricht senden
    document.getElementById('chat-form').addEventListener('submit', sendMessage);
    document.getElementById('send-button').addEventListener("touchend", (e) => {
        e.preventDefault();
        sendMessage(e); // Event für Touch-Ende hinzufügen
    });
        

    
    
    // Load last Messages on window load    
    window.onload = function(){
        requestHistoryMessages(0,100);
        setTimeout(() => {
            scrollMessagesToBottom();
        }, 2500);
    }  
    
    // Automatic reload when scrolled to the top
    messagesUL.addEventListener('scroll', function() {
        if (messagesUL.scrollTop === 0) {
            if (currently_loading_messages == false){
                console.log("at the top, triggerin reload");
                currently_loading_messages = true;
                let num = messagesUL.querySelectorAll('.message').length;
                console.log("REQUESTING:", num, 50);
                requestHistoryMessages(num, 50);
            }
        }
    });

    document.getElementById('logout-button').addEventListener('click', async () => {
    try {
        const response = await fetch('/api/logout', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        });

        const result = await response.json();

        if (result.success) {
        alert('Logout success!')
        window.location.href = '/index.html';  // Redirect to login page after logout
        } else {
        alert('Logout failed');
        }
    } catch (error) {
        console.error('Error logging out:', error);
    }
    });

    
    
            
    </script>
</body>
</html>
