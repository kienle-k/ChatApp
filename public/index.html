<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/style.css">
    <title>Echtzeit-Chat</title>
</head>
<body>
    <h1>Echtzeit-Chat</h1>
    <div id="chat-container">
        <!-- <div id="message-history-container"> -->
            <ul id="messages"></ul>
        <!-- </div> -->
        <div id="send-container">
            <form id="chat-form">
                <input id="message-input" autocomplete="off" /><button id="send-button">Senden</button>
            </form>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Verbindung mit dem Socket.IO-Server herstellen
        const socket = io();

        var pending_messages = [];

        const input = document.getElementById("message-input");
        const messageContainer = document.getElementById('message-history-container');
        const messagesUL = document.getElementById('messages');

        function scrollMessagesToBottom(){
            messagesUL.scrollTop = messagesUL.scrollHeight;
        }

        function addMessage(message, messageType){
            // messageType can be 'pending' / 'sent' / 'received'

            // Nachricht sofort anzeigen
            const li = document.createElement('li');

            li.classList.add("message-container");            
            
            const msg = document.createElement('div');

            msg.innerText = message;

            msg.classList.add('message');
            msg.classList.add('new-message');
            
            switch(messageType) {
                case "pending":
                li.classList.add('right');
                msg.classList.add('pending-message');
                    break;
                
                case "sent":
                    li.classList.add('right');
                    msg.classList.add('sent-message');
                    break;
                
                case "received":
                    li.classList.add('left');
                    msg.classList.add('received-message');
                    break;
            }

            li.appendChild(msg);

            messagesUL.appendChild(li);

            // msg.addEventListener('transitionend', scrollMessagesToBottom);
            setTimeout(() => {
                msg.classList.add('expanded');
            }, 10);

            return li;
        }


        // Wenn eine Nachricht empfangen wird
        socket.on('chat message', (msg) => {
            console.log("RECEIVED:", msg);
            let li = addMessage(msg, 'received');

            setTimeout(scrollMessagesToBottom, 0);
          
        });

        // Wenn eine Nachricht als bestätigt zurückkommt
        socket.on('message confirmation', (msgID) => {
            // Suchen der Nachricht mit der erhaltenen msgID
            const li = pending_messages[msgID];
            if (li) {
                const msg = li.querySelector("div");
                msg.classList.remove('pending-message'); // Entfernt den Pending-Status
                msg.classList.add('sent-message'); // Fügt die normale Nachricht-Klasse hinzu
                // Hier ein Script ausführen, z. B. Animation oder Bestätigung
                console.log("Message confirmed sent: " + msgID);
                delete pending_messages[msgID]; // Entferne das Pending-Tracking
            }
        });


        // Nachricht senden
        document.getElementById('chat-form').addEventListener('submit', (event) => {
            event.preventDefault(); // Verhindert, dass das Formular standardmäßig gesendet wird
            const msgID = Date.now(); // Einzigartige ID für die Nachricht (kann auch anders generiert werden)

            if (input.value == ""){
                return;
            }
            let msgLi = addMessage(input.value, 'pending');
            pending_messages[msgID] = msgLi;

            setTimeout(scrollMessagesToBottom, 0);

            // Nachricht mit ID an den Server senden
            socket.emit('chat message', { id: msgID, text: input.value }); 
            input.value = ''; // Eingabefeld leeren
        });
    </script>
</body>
</html>
